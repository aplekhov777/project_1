---
title: "Project 1"
author: "Name: A.Plekhov\n Partners: A.Lopez, S.L.Ramesh  "
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
---

```{r setup, include = FALSE}

#### Load necessary packages ####
# * These packages are not necessary to complete the assignment and or only used 
#   to provide an example. 
#packages <- c("knitr", "kableExtra", "magrittr", "readr", "geosphere")

#install_me <- packages[!(packages %in% installed.packages()[, "Package"])]
#if (length(install_me)) install.packages(install_me)

library(knitr)
#library(kableExtra)
library(magrittr)
library(readr)
library(geosphere)
#
```
#####

## Link to the GitHub repository used for collaboration 
>[https://github.com/aplekhov777/project_1.git](https://github.com/aplekhov777/project_1.git)

## Data
> [2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository by John Hopkins CSSE](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series)


## Project Objectives

### Objective 1
To find out were the COVID originated from we will find the row(s) 
with maximum value in "1/22/20" column in all 3 files. 

```{r ob1}
#library(curl)
fileNames <- c(
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"
)
df3 <- data.frame(
                  Country.Region=character(),
                  Province.State=character(),
                  File=character()
                  )
for (fileName in fileNames){
mydata1 <- read.csv(fileName)
df1 <- data.frame(mydata1)
df2 <- df1[which(df1$"X1.22.20" == max(df1[,5])) , 1:4]
df2["File"] <- fileName
df3 <- rbind(df3,df2)
}

if ((df3[1,1] == df3[2,1]) & (df3[1,1] == df3[3,1])){
  cat("The origin of covid is" , as.character(df3[1,1]) , as.character(df3[1,2])  )
} else {
  print(df3)
}


```

### Objective 2
To find the most recent area to have a first confirmed case we need
to find the max lendth of vector filled vith zeros in each row
````{r ob2}
mydata1 <- read.csv("https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
df12 <- data.frame(mydata1)
df22 <- subset(df12[5:ncol(df1)])
df32 <- subset(df12[1:4])


num_cases <- apply(df22 , 1 , function(x) head(x[x > 0],1))
v_days <-c()

for (i in 1:nrow(df22)){
  day <- apply(df22[i,],1, function(x) match (x,x = num_cases[i]))-1
  v_days <- append(v_days,day)
}

index <- which(v_days==max(v_days)) #index of max value

#index <- c(183,184) #to check the ob3 execution


df_countries <- subset(df32[index,])
df_countries
df_countries[4:3]#Most recent area to have a first confirmed case
#Number of day without infection
#max(v_days)
```

### Objective 3
```{r ob3}
library(geosphere)
#LONG LAT

ob1 <- df3[1,4:3] 
ob2 <- df_countries[4:3]
miles <- distm(ob1,ob2)/1609.344 
miles # matrix of distances
for(i in 1:nrow(df_countries)){
  cat(as.character(df_countries[i,2]) , "is" , miles[i], "away from" ,as.character(df3[1,1]) , as.character(df3[1,2]), "\n" )
}

```

### Objective 4.1

Before we conduct the calculation we got to prepare the data. Here is the plan:
1.After downloading and subsetting the dataframes we got to remove rows containing 
zero values in columns Lat, Long and last column. Reasons: avoidance of obtaining 
zeros and Infinity in results and eliminating some ships (coordinates 0,0) because we 
going to make "inner join" by coordinates and they give odd and outlying results.
2. After merging we will calculate the values in the same dataframe then sort and subset. 


```{r ob4.1}

fileNames <- c(
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
  "https://github.com/aplekhov777/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"
)
com_list <- list()
for (fileName in fileNames){
mydata1 <- read.csv(fileName)
df1 <- data.frame(mydata1)
df1 <- subset(df1[c(1:4,ncol(df1))])

df1 <- cbind(df1, lapply(df1[3:5],as.numeric))
df1 <- df1[!(apply(df1[5:8], 1, function(y) any(y == 0))),]
table_name <- unlist(strsplit(fileName, "\\_"))[11]
colnames(df1)[8] <- table_name
df1 <- subset(df1[c(1,2,6:8)])
com_list[[table_name]] <- df1
}

df2 <- merge (com_list[[1]],
             com_list[[2]] ,
             by = c("Lat","Long")
)
merged <-   merge (df2,
             com_list[[3]],
             by = c("Lat","Long")
)           
merged <- subset(merged[c(1:5,8,11)]) # final merged dataframe

merged$risk <- "risk"
merged["risk"] <- round(merged["deaths"]/merged["recovered"] ,4)


merged$burden <- "burden"
merged["burden"] <- round(merged["confirmed"]*merged["risk"],2)
#
#
# the least risky part of the world:
least_risky <- subset(merged, risk == min(merged["risk"]))
least_risky[c(1:4,8)]
#
#
# the most risky part of the world:
most_risky <- subset(merged, risk == max(merged["risk"]))
most_risky[c(1:4,8)]
#
#
# global risk score:
colMeans(merged["risk"])
#
#
# compare burden
least_risky[c(3:4,8,9)]
most_risky[c(3:4,8,9)]
cat(
   "Death burden in",
   as.character(most_risky$Province.State.x), 
   as.character(most_risky$Country.Region.x), 
   "is",
   as.numeric(round(most_risky[9]/least_risky[9])),
   "times higher,than in", 
   as.character(least_risky$Province.State.x), 
   as.character(least_risky$Country.Region.x))
#
#
#
```
Do these values seem reasonable?

Seems reasonable to me.
The risk is reflecting the death rate and the burden is kind of approximation of 
lethal cases in the future, if everything remains the same.
More the risk- more burden. Methods to make positive changes:
decrease deaths and confirmed cases and increase recovery cases.

What are some possible causes for this discrepancy?

```{r}
#Lets represent table like this.
#The top 5 risk countries, and top least in the second table:
top5 <-head(merged[order(-merged$risk),]) # table ordered in risk acceding
kable(top5[c(3:4,8,9)])
top5 <-head(merged[order(merged$risk),]) # table ordered in risk descending
kable(top5[c(3:4,8,9)])

```
The burden has too much variation between countries. Would be interesting to see
it adjusted against density of population. Probably one of the main reasons of variability is
the lack of standardized procedure for the registering that three parameters.


Why might it be helpful to calculate metrics like risk scores or burden scores for different areas of the world
and what would its limitations be (what assumptions does it make and important variables might be left out)?

To calculate those metrics might be helpful for global organizations like WHO to distribute 
their funds and efforts accordingly and predict the development of the situation.
This metrics assume that people equally susceptible to infection, do not take in consideration of the
different ages people have (may be the average age), population densities, economical factors in the countries.


```{r}
#
#
#the rest of risk and burden data by country
#kable(merged[c(3:4,8:9)])
```





### Objective 4.2
```{r ob4.2}
library(dplyr)
library(knitr)

#fileNames <- Sys.glob("*.csv")
for (fileName in fileNames){
mydata1 <- read.csv(fileName)
last_col <- ncol(data.frame(mydata1))
df5 <- subset(data.frame(mydata1)[c(1:2,last_col)])
cur_col <- colnames(data.frame(mydata1)[last_col])
df50 <- df5 %>% group_by(Country.Region) 
df52 <- df50 %>%  summarize(total = sum (.data[[cur_col]]) )
df53 <- arrange(df52,-total)
file_name <- unlist(strsplit(fileName, "\\/"))[10]
cat("\n","Top 5 territories group by country, derived from the file:","\n",file_name)
print(kable(head(df53  ,5)),"\n")
}
```

## GitHub Log
```{bash gitlog} 
git log --pretty=format:"%nSubject: %s%nAuthor: %aN%nDate: %aD%nBody: %b"
```





